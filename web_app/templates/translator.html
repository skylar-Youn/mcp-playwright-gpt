<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‡¼ì¸  ë²ˆì—­ ë° ì¬í•´ì„ê¸°</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="brand">
                <h1><a href="/">ìœ íŠœë¸Œ ì œì‘ê¸°</a> / ì‡¼ì¸  ë²ˆì—­ê¸°</h1>
            </div>
        </header>

        <div id="project-view" class="hidden">
            <section class="panel">
                <div class="panel-header">
                    <h2 id="project-title"></h2>
                    <p id="project-status" class="panel-subtitle"></p>
                </div>
                <div id="project-actions"></div>
            </section>
            <section class="panel">
                <h3>ë²ˆì—­ ê²°ê³¼</h3>
                <div id="segments-table" class="segments-table"></div>
            </section>
        </div>

        <div id="creation-view">
            <section class="panel">
                <div class="panel-header">
                    <h2>1. ì†ŒìŠ¤ ì„ íƒ</h2>
                    <p class="panel-subtitle">ë²ˆì—­í•  ì˜ìƒê³¼ ìë§‰ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”. íŒŒì¼ì€ <code>youtube/download</code> í´ë”ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.</p>
                </div>
                <div id="downloads-list" class="downloads-list">
                    <p class="empty-state">ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    <p class="empty-state" style="color: #666; font-size: 0.9em;">
                        ë§Œì•½ ì´ ë©”ì‹œì§€ê°€ ê³„ì† í‘œì‹œëœë‹¤ë©´
                        <button onclick="location.reload(true)" style="margin: 0 5px; padding: 2px 8px;">ê°•ì œ ìƒˆë¡œê³ ì¹¨</button>
                        ë˜ëŠ” ê°œë°œì ë„êµ¬(F12)ì—ì„œ ì½˜ì†” ì˜¤ë¥˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
                    </p>
                </div>
            </section>

            <section class="panel" id="ai-commentary-section">
                <div class="panel-header">
                    <h2>2. AI í•´ì„¤ ìƒì„±</h2>
                    <p class="panel-subtitle">ì„ íƒëœ ì˜ìƒì˜ ìë§‰ì„ ë¶„ì„í•˜ì—¬ AIê°€ ìë™ìœ¼ë¡œ í•´ì„¤ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
                </div>
                <div id="selected-source-info" class="source-info">
                    <div class="source-details">
                        <h4 id="selected-source-title">ì„ íƒëœ ì†ŒìŠ¤</h4>
                        <p><strong>ì˜ìƒ:</strong> <span id="selected-video-name">ì„ íƒë˜ì§€ ì•ŠìŒ</span></p>
                        <p><strong>ìë§‰:</strong> <span id="selected-subtitle-name">ì„ íƒë˜ì§€ ì•ŠìŒ</span></p>
                    </div>
                </div>
                <div class="ai-commentary-controls">
                    <button type="button" id="generate-commentary-btn" class="btn-primary">
                        AI í•´ì„¤ ìƒì„±í•˜ê¸°
                    </button>
                    <button type="button" id="skip-commentary-btn" class="btn-secondary">
                        ê±´ë„ˆë›°ê¸°
                    </button>
                </div>
                <div id="commentary-generation-status" class="status-message" style="display: none;">
                    <p>AIê°€ í•´ì„¤ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
            </section>

            <section class="panel" id="translation-settings-section">
                <div class="panel-header">
                    <h2>3. ë²ˆì—­ ì„¤ì •</h2>
                    <div>
                        <button type="button" id="load-settings-btn" class="btn-secondary btn-sm">ì§€ë‚œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button type="button" id="save-settings-btn" class="btn-secondary btn-sm">ì„¤ì • ì €ì¥</button>
                    </div>
                </div>
                <form id="creation-form" class="form-grid" autocomplete="off">
                    <div class="form-group">
                        <label for="target-lang">ëª©í‘œ ì–¸ì–´</label>
                        <select id="target-lang" name="target_lang" class="form-control" autocomplete="off">
                            <option value="ko">í•œêµ­ì–´</option>
                            <option value="en">English</option>
                            <option value="ja" selected>æ—¥æœ¬èª</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="translation-mode">ë²ˆì—­ ëª¨ë“œ</label>
                        <select id="translation-mode" name="translation_mode" class="form-control">
                            <option value="adaptive">ì ì‘í˜•</option>
                            <option value="literal">ì§ì—­</option>
                            <option value="reinterpret" selected>ì¬í•´ì„ (ê¸°ë³¸)</option>
                        </select>
                    </div>
                    <div class="form-group form-group-full">
                        <label for="tone-hint">í†¤/ìŠ¤íƒ€ì¼ íŒíŠ¸ (ì„ íƒ ì‚¬í•­)</label>
                        <input type="text" id="tone-hint" name="tone_hint" class="form-control" placeholder="ë“œë¼ë§ˆí•˜ê³  ìœ ì¾Œí•˜ë©´ì„œ ìœ ë¨¸ëŸ¬ìŠ¤í•˜ê²Œ" value="ë“œë¼ë§ˆí•˜ê³  ìœ ì¾Œí•˜ë©´ì„œ ìœ ë¨¸ëŸ¬ìŠ¤í•˜ê²Œ">
                    </div>
                    <div class="form-group form-group-full">
                        <button type="submit" class="btn-primary">ë²ˆì—­ í”„ë¡œì íŠ¸ ìƒì„±</button>
                    </div>
                </form>
            </section>
        </div>
    </div>



    <script>
    (function () {
        const creationView = document.getElementById('creation-view');
        const projectView = document.getElementById('project-view');
        const downloadsList = document.getElementById('downloads-list');
        const creationForm = document.getElementById('creation-form');

        const projectTitle = document.getElementById('project-title');
        const projectStatus = document.getElementById('project-status');
        const projectActions = document.getElementById('project-actions');
        const segmentsTable = document.getElementById('segments-table');

        let selectedSource = null;
        let currentProject = null;



        function renderDownloads(items) {
            if (!items || !items.length) {
                downloadsList.innerHTML = '<p class="empty-state">ë‹¤ìš´ë¡œë“œëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤. <a href="/ytdl">ìœ íŠœë¸Œ ë‹¤ìš´ë¡œë“œ</a> ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¨¼ì € ì˜ìƒì„ ë°›ì•„ì£¼ì„¸ìš”.</p>';
                return;
            }
            const html = items.map((item, index) => {
                const hasSubtitle = item.subtitle_path;
                const videoName = item.base_name;
                const subtitleName = hasSubtitle ? item.subtitle_path.split('/').pop() : 'ìë§‰ ì—†ìŒ';
                return `
                    <div class="download-item" data-index="${index}">
                        <div class="item-header">
                            <input type="radio" name="source" id="source-${index}" value="${index}">
                            <label for="source-${index}">${videoName}</label>
                        </div>
                        <div class="item-meta">
                            <span>${item.video_path}</span>
                            <span class="${hasSubtitle ? 'text-success' : 'text-warning'}">${subtitleName}</span>
                        </div>
                    </div>
                `;
            }).join('');
            downloadsList.innerHTML = `<div class="form-group">${html}</div>`;
            downloadsList.querySelectorAll('input[name="source"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    const selectedIndex = parseInt(event.target.value, 10);
                    selectedSource = items[selectedIndex];
                    showAICommentarySection();
                });
            });
        }

        function fetchDownloads() {
            downloadsList.innerHTML = '<p class="empty-state">API í˜¸ì¶œ ì¤‘...</p>';

            // Add cache busting parameter
            const cacheBuster = Date.now();
            fetch(`/api/translator/downloads?_cb=${cacheBuster}`)
                .then(res => {
                    if (res.ok) {
                        return res.json();
                    } else {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                })
                .then(data => {
                    renderDownloads(data);
                })
                .catch(err => {
                    console.error('Download fetch error:', err);
                    downloadsList.innerHTML = `<p class="empty-state error">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}</p>`;
                });
        }

        function applySettings(settings) {
            // alert('Received settings: ' + JSON.stringify(settings));
            if (settings) {
                document.getElementById('target-lang').value = settings.target_lang || 'ja';
                document.getElementById('translation-mode').value = settings.translation_mode || 'reinterpret';
                document.getElementById('tone-hint').value = settings.tone_hint || 'ë“œë¼ë§ˆí•˜ê³  ìœ ì¾Œí•˜ë©´ì„œ ìœ ë¨¸ëŸ¬ìŠ¤í•˜ê²Œ';
            }
        }

        const loadSettingsBtn = document.getElementById('load-settings-btn');
        if (loadSettingsBtn) {
            loadSettingsBtn.addEventListener('click', () => {
                fetch('/api/translator/settings')
                    .then(res => res.ok ? res.json() : Promise.reject(res))
                    .then(applySettings)
                    .catch(err => {
                        console.error(err);
                        alert('ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    });
            });
        }

        const saveSettingsBtn = document.getElementById('save-settings-btn');
        if (saveSettingsBtn) {
            saveSettingsBtn.addEventListener('click', () => {
                const formData = new FormData(creationForm);
                const settings = {
                    target_lang: formData.get('target_lang'),
                    translation_mode: formData.get('translation_mode'),
                    tone_hint: formData.get('tone_hint') || null,
                };

                fetch('/api/translator/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings),
                })
                .then(res => res.ok ? res.json() : Promise.reject(res))
                .then(result => {
                    alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                })
                .catch(err => {
                    console.error(err);
                    alert('ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                });
            });
        }

        creationForm.addEventListener('submit', (event) => {
            event.preventDefault();
            if (!selectedSource) {
                alert('ë²ˆì—­í•  ì†ŒìŠ¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            const formData = new FormData(creationForm);
            const payload = {
                source_video: selectedSource.video_path,
                source_subtitle: selectedSource.subtitle_path || null,
                target_lang: formData.get('target_lang'),
                translation_mode: formData.get('translation_mode'),
                tone_hint: formData.get('tone_hint') || null,
            };
            const submitButton = creationForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'ìƒì„± ì¤‘...';
            fetch('/api/translator/projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            })
            .then(res => res.ok ? res.json() : Promise.reject(res))
            .then(project => {
                window.location.href = `/translator?id=${project.id}`;
            })
            .catch(err => {
                console.error(err);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            })
            .finally(() => {
                submitButton.disabled = false;
                submitButton.textContent = 'ë²ˆì—­ í”„ë¡œì íŠ¸ ìƒì„±';
            });
        });

        function renderProject(project) {
            currentProject = project;
            creationView.classList.add('hidden');
            projectView.classList.remove('hidden');

            projectTitle.textContent = project.base_name;
            projectStatus.textContent = `ìƒíƒœ: ${project.status}`;

            // Reconstruct selectedSource from project data
            if (project.source_video) {
                selectedSource = {
                    video_path: project.source_video,
                    subtitle_path: project.source_subtitle,
                    base_name: project.base_name
                };
            }

            projectActions.innerHTML = ''; // Clear actions

            // Always show delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.id = 'delete-project-btn';
            deleteBtn.className = 'btn-secondary';
            deleteBtn.style.background = 'linear-gradient(120deg, #ff6d6d, #ff3d7f)';
            deleteBtn.style.color = '#fff6f6';
            deleteBtn.textContent = 'í”„ë¡œì íŠ¸ ì‚­ì œ';
            deleteBtn.addEventListener('click', deleteProject);
            projectActions.appendChild(deleteBtn);

            if (project.status === 'segmenting' || project.status === 'draft') {
                const translateBtn = document.createElement('button');
                translateBtn.id = 'translate-btn';
                translateBtn.className = 'btn-primary';
                translateBtn.textContent = 'ë²ˆì—­ ì‹¤í–‰';
                translateBtn.addEventListener('click', runTranslation);
                projectActions.appendChild(translateBtn);

                const commentaryBtn = document.createElement('button');
                commentaryBtn.id = 'korean-commentary-btn';
                commentaryBtn.className = 'btn-secondary';
                commentaryBtn.textContent = 'í•œêµ­ì–´ AI í•´ì„¤ ë„£ê¸°';
                commentaryBtn.style.background = '#28a745';
                commentaryBtn.style.color = 'white';
                commentaryBtn.addEventListener('click', generateKoreanCommentary);
                projectActions.appendChild(commentaryBtn);
            } else if (project.status === 'voice_ready') {
                // Voice synthesis mode selector
                const voiceModeDiv = document.createElement('div');
                voiceModeDiv.style.display = 'flex';
                voiceModeDiv.style.alignItems = 'center';
                voiceModeDiv.style.gap = '10px';
                voiceModeDiv.style.marginBottom = '10px';

                const voiceModeLabel = document.createElement('label');
                voiceModeLabel.textContent = 'ìŒì„± í•©ì„± ëŒ€ìƒ:';
                voiceModeLabel.style.fontWeight = 'bold';

                const voiceModeSelect = document.createElement('select');
                voiceModeSelect.id = 'voice-synthesis-mode';
                voiceModeSelect.innerHTML = `
                    <option value="subtitle" ${project.voice_synthesis_mode === 'subtitle' ? 'selected' : ''}>ìë§‰ë§Œ</option>
                    <option value="commentary" ${project.voice_synthesis_mode === 'commentary' ? 'selected' : ''}>í•´ì„¤ë§Œ</option>
                    <option value="both" ${project.voice_synthesis_mode === 'both' ? 'selected' : ''}>ìë§‰+í•´ì„¤</option>
                `;
                voiceModeSelect.addEventListener('change', updateVoiceSynthesisMode);

                voiceModeDiv.appendChild(voiceModeLabel);
                voiceModeDiv.appendChild(voiceModeSelect);
                projectActions.appendChild(voiceModeDiv);

                const voiceBtn = document.createElement('button');
                voiceBtn.id = 'voice-btn';
                voiceBtn.className = 'btn-primary';
                voiceBtn.textContent = 'ìŒì„± ìƒì„±';
                voiceBtn.addEventListener('click', runVoiceSynthesis);
                projectActions.appendChild(voiceBtn);

                const reverseTranslateAllBtn = document.createElement('button');
                reverseTranslateAllBtn.id = 'reverse-translate-all-btn';
                reverseTranslateAllBtn.className = 'btn-secondary';
                reverseTranslateAllBtn.style.background = 'rgba(255, 209, 102, 0.15)';
                reverseTranslateAllBtn.style.border = '1px solid rgba(255, 209, 102, 0.6)';
                reverseTranslateAllBtn.style.color = '#ffd166';
                reverseTranslateAllBtn.textContent = 'ì „ì²´ ì—­ë²ˆì—­';
                reverseTranslateAllBtn.addEventListener('click', runReverseTranslateAll);
                projectActions.appendChild(reverseTranslateAllBtn);
            } else if (project.status === 'voice_complete') {
                // Voice synthesis mode selector (keep it for re-generation)
                const voiceModeDiv = document.createElement('div');
                voiceModeDiv.style.display = 'flex';
                voiceModeDiv.style.alignItems = 'center';
                voiceModeDiv.style.gap = '10px';
                voiceModeDiv.style.marginBottom = '10px';

                const voiceModeLabel = document.createElement('label');
                voiceModeLabel.textContent = 'ìŒì„± í•©ì„± ëŒ€ìƒ:';
                voiceModeLabel.style.fontWeight = 'bold';

                const voiceModeSelect = document.createElement('select');
                voiceModeSelect.id = 'voice-synthesis-mode';
                voiceModeSelect.innerHTML = `
                    <option value="subtitle" ${project.voice_synthesis_mode === 'subtitle' ? 'selected' : ''}>ìë§‰ë§Œ</option>
                    <option value="commentary" ${project.voice_synthesis_mode === 'commentary' ? 'selected' : ''}>í•´ì„¤ë§Œ</option>
                    <option value="both" ${project.voice_synthesis_mode === 'both' ? 'selected' : ''}>ìë§‰+í•´ì„¤</option>
                `;
                voiceModeSelect.addEventListener('change', updateVoiceSynthesisMode);

                voiceModeDiv.appendChild(voiceModeLabel);
                voiceModeDiv.appendChild(voiceModeSelect);
                projectActions.appendChild(voiceModeDiv);

                const editBtn = document.createElement('button');
                editBtn.id = 'edit-btn';
                editBtn.className = 'btn-secondary';
                editBtn.textContent = 'í¸ì§‘ ëª¨ë“œë¡œ ëŒì•„ê°€ê¸°';
                editBtn.addEventListener('click', () => {
                    // Reset project status to allow editing
                    fetch(`/api/translator/projects/${currentProject.id}/reset-to-translated`, {
                        method: 'POST'
                    })
                    .then(res => res.ok ? res.json() : Promise.reject(res))
                    .then(renderProject)
                    .catch(err => {
                        console.error(err);
                        alert('í¸ì§‘ ëª¨ë“œ ì „í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    });
                });
                projectActions.appendChild(editBtn);

                const voiceBtn = document.createElement('button');
                voiceBtn.id = 'voice-btn';
                voiceBtn.className = 'btn-secondary';
                voiceBtn.textContent = 'ìŒì„± ì¬ìƒì„±';
                voiceBtn.addEventListener('click', runVoiceSynthesis);
                projectActions.appendChild(voiceBtn);

                const reverseTranslateAllBtn = document.createElement('button');
                reverseTranslateAllBtn.id = 'reverse-translate-all-btn';
                reverseTranslateAllBtn.className = 'btn-secondary';
                reverseTranslateAllBtn.textContent = 'ì „ì²´ ì—­ë²ˆì—­';
                reverseTranslateAllBtn.addEventListener('click', runReverseTranslateAll);
                projectActions.appendChild(reverseTranslateAllBtn);

                const renderBtn = document.createElement('button');
                renderBtn.id = 'render-btn';
                renderBtn.className = 'btn-primary';
                renderBtn.textContent = 'ë¹„ë””ì˜¤ ë Œë”ë§';
                renderBtn.addEventListener('click', runRender);
                projectActions.appendChild(renderBtn);
            }

            const segmentsHtml = project.segments.map((seg, index) => `
                <div class="segment-item" data-segment-id="${seg.id}">
                    <div class="segment-header">
                        <div class="segment-time" data-segment-id="${seg.id}">
                            <span class="time-display" style="cursor: pointer; color: #007bff; text-decoration: underline;" title="í´ë¦­í•˜ì—¬ ì‹œê°„ ìˆ˜ì •">
                                ${seg.start.toFixed(2)} - ${seg.end.toFixed(2)}
                            </span>
                            <div class="time-edit" style="display: none;">
                                <input type="number" class="start-input" step="0.01" value="${seg.start.toFixed(2)}" min="0" style="width: 60px;">
                                <span> - </span>
                                <input type="number" class="end-input" step="0.01" value="${seg.end.toFixed(2)}" min="0" style="width: 60px;">
                                <button class="btn-save-time" style="margin-left: 5px; font-size: 12px; padding: 2px 6px; background: #28a745; color: white; border: none; border-radius: 3px;">ì €ì¥</button>
                                <button class="btn-cancel-time" style="margin-left: 2px; font-size: 12px; padding: 2px 6px; background: #6c757d; color: white; border: none; border-radius: 3px;">ì·¨ì†Œ</button>
                            </div>
                        </div>
                        <div class="segment-actions">
                            <button class="btn-move-up" data-segment-id="${seg.id}" title="ìœ„ë¡œ ì´ë™">â¬†ï¸</button>
                            <button class="btn-move-down" data-segment-id="${seg.id}" title="ì•„ë˜ë¡œ ì´ë™">â¬‡ï¸</button>
                            <button class="btn-edit-segment" data-segment-id="${seg.id}" title="ì„¸ê·¸ë¨¼íŠ¸ ìˆ˜ì •">âœï¸</button>
                            <button class="btn-delete-segment" data-segment-id="${seg.id}" title="ì„¸ê·¸ë¨¼íŠ¸ ì‚­ì œ">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="segment-content">
                        <div class="text-pair">
                            <div class="text-row korean original">
                                <label>ì›ë³¸ í•œêµ­ì–´:</label>
                                <div class="text-content" data-type="source" data-segment-id="${seg.id}">
                                    <span class="text-display">${seg.source_text || ''}</span>
                                    <input class="text-edit" type="text" value="${(seg.source_text || '').replace(/"/g, '&quot;')}" style="display: none;">
                                    <div class="text-buttons">
                                        <button class="btn-edit-text" data-type="source" data-segment-id="${seg.id}" title="í•œêµ­ì–´ ìˆ˜ì •">ìˆ˜ì •</button>
                                        <button class="btn-copy-text" data-type="source" data-segment-id="${seg.id}" title="í•œêµ­ì–´ ë³µì‚¬">ë³µì‚¬</button>
                                        <button class="btn-delete-text" data-type="source" data-segment-id="${seg.id}" title="í•œêµ­ì–´ ì‚­ì œ">ì‚­ì œ</button>
                                    </div>
                                    <div class="last-modified" style="font-size: 0.8em; color: #888; margin-top: 4px;"></div>
                                </div>
                            </div>
                            <div class="text-row japanese">
                                <label>ë²ˆì—­ ì¼ë³¸ì–´:</label>
                                <div class="text-content" data-type="translated" data-segment-id="${seg.id}">
                                    <span class="text-display">${seg.translated_text || ''}</span>
                                    <input class="text-edit" type="text" value="${(seg.translated_text || '').replace(/"/g, '&quot;')}" style="display: none;">
                                    <div class="text-buttons">
                                        <button class="btn-edit-text" data-type="translated" data-segment-id="${seg.id}" title="ì¼ë³¸ì–´ ìˆ˜ì •">ìˆ˜ì •</button>
                                        <button class="btn-copy-text" data-type="translated" data-segment-id="${seg.id}" title="ì¼ë³¸ì–´ ë³µì‚¬">ë³µì‚¬</button>
                                        <button class="btn-translate-reverse" data-segment-id="${seg.id}" title="ì¼ë³¸ì–´â†’í•œêµ­ì–´ ë²ˆì—­">ì—­ë²ˆì—­</button>
                                        <button class="btn-delete-text" data-type="translated" data-segment-id="${seg.id}" title="ì¼ë³¸ì–´ ì‚­ì œ">ì‚­ì œ</button>
                                    </div>
                                    <div class="last-modified" style="font-size: 0.8em; color: #888; margin-top: 4px;"></div>
                                </div>
                            </div>
                            <div class="text-row korean reverse">
                                <label>ì—­ë²ˆì—­ í•œêµ­ì–´:</label>
                                <div class="text-content" data-type="reverse_translated" data-segment-id="${seg.id}">
                                    <span class="text-display">${seg.reverse_translated_text || ''}</span>
                                    <input class="text-edit" type="text" value="${(seg.reverse_translated_text || '').replace(/"/g, '&quot;')}" style="display: none;">
                                    <div class="text-buttons">
                                        <button class="btn-edit-text" data-type="reverse_translated" data-segment-id="${seg.id}" title="ì—­ë²ˆì—­ í•œêµ­ì–´ ìˆ˜ì •">ìˆ˜ì •</button>
                                        <button class="btn-copy-text" data-type="reverse_translated" data-segment-id="${seg.id}" title="ì—­ë²ˆì—­ í•œêµ­ì–´ ë³µì‚¬">ë³µì‚¬</button>
                                        <button class="btn-delete-text" data-type="reverse_translated" data-segment-id="${seg.id}" title="ì—­ë²ˆì—­ í•œêµ­ì–´ ì‚­ì œ">ì‚­ì œ</button>
                                    </div>
                                    <div class="last-modified" style="font-size: 0.8em; color: #888; margin-top: 4px;"></div>
                                </div>
                            </div>
                            <div class="text-row commentary korean">
                                <label>í•´ì„¤ í•œêµ­ì–´:</label>
                                <div class="text-content" data-type="commentary_korean" data-segment-id="${seg.id}">
                                    <span class="text-display">${seg.commentary_korean || ''}</span>
                                    <textarea class="text-edit" style="display: none; min-height: 60px; resize: vertical;">${(seg.commentary_korean || '').replace(/"/g, '&quot;')}</textarea>
                                    <div class="text-buttons">
                                        <button class="btn-edit-text" data-type="commentary_korean" data-segment-id="${seg.id}" title="í•´ì„¤ í•œêµ­ì–´ ìˆ˜ì •">ìˆ˜ì •</button>
                                        <button class="btn-copy-text" data-type="commentary_korean" data-segment-id="${seg.id}" title="í•´ì„¤ í•œêµ­ì–´ ë³µì‚¬">ë³µì‚¬</button>
                                        <button class="btn-delete-text" data-type="commentary_korean" data-segment-id="${seg.id}" title="í•´ì„¤ í•œêµ­ì–´ ì‚­ì œ">ì‚­ì œ</button>
                                    </div>
                                    <div class="last-modified" style="font-size: 0.8em; color: #888; margin-top: 4px;"></div>
                                </div>
                            </div>
                            <div class="text-row commentary japanese">
                                <label>í•´ì„¤ ì¼ë³¸ì–´:</label>
                                <div class="text-content" data-type="commentary_japanese" data-segment-id="${seg.id}">
                                    <span class="text-display">${seg.commentary_japanese || ''}</span>
                                    <textarea class="text-edit" style="display: none; min-height: 60px; resize: vertical;">${(seg.commentary_japanese || '').replace(/"/g, '&quot;')}</textarea>
                                    <div class="text-buttons">
                                        <button class="btn-edit-text" data-type="commentary_japanese" data-segment-id="${seg.id}" title="í•´ì„¤ ì¼ë³¸ì–´ ìˆ˜ì •">ìˆ˜ì •</button>
                                        <button class="btn-copy-text" data-type="commentary_japanese" data-segment-id="${seg.id}" title="í•´ì„¤ ì¼ë³¸ì–´ ë³µì‚¬">ë³µì‚¬</button>
                                        <button class="btn-delete-text" data-type="commentary_japanese" data-segment-id="${seg.id}" title="í•´ì„¤ ì¼ë³¸ì–´ ì‚­ì œ">ì‚­ì œ</button>
                                    </div>
                                    <div class="last-modified" style="font-size: 0.8em; color: #888; margin-top: 4px;"></div>
                                </div>
                            </div>
                            <div class="text-row commentary reverse">
                                <label>í•´ì„¤ ì—­ë²ˆì—­ í•œêµ­ì–´:</label>
                                <div class="text-content" data-type="commentary_reverse_korean" data-segment-id="${seg.id}">
                                    <span class="text-display">${seg.commentary_reverse_korean || ''}</span>
                                    <textarea class="text-edit" style="display: none; min-height: 60px; resize: vertical;">${(seg.commentary_reverse_korean || '').replace(/"/g, '&quot;')}</textarea>
                                    <div class="text-buttons">
                                        <button class="btn-edit-text" data-type="commentary_reverse_korean" data-segment-id="${seg.id}" title="í•´ì„¤ ì—­ë²ˆì—­ í•œêµ­ì–´ ìˆ˜ì •">ìˆ˜ì •</button>
                                        <button class="btn-copy-text" data-type="commentary_reverse_korean" data-segment-id="${seg.id}" title="í•´ì„¤ ì—­ë²ˆì—­ í•œêµ­ì–´ ë³µì‚¬">ë³µì‚¬</button>
                                        <button class="btn-delete-text" data-type="commentary_reverse_korean" data-segment-id="${seg.id}" title="í•´ì„¤ ì—­ë²ˆì—­ í•œêµ­ì–´ ì‚­ì œ">ì‚­ì œ</button>
                                    </div>
                                    <div class="last-modified" style="font-size: 0.8em; color: #888; margin-top: 4px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            segmentsTable.innerHTML = segmentsHtml;

            // Add event listeners for edit/delete buttons
            attachSegmentEventListeners();
            attachTimeEditListeners();

            // Update AI commentary section with selected source info
            showAICommentarySection();
        }

        function runTranslation() {
            const btn = document.getElementById('translate-btn');
            btn.disabled = true;
            btn.textContent = 'ë²ˆì—­ ì¤‘...';

            fetch(`/api/translator/projects/${currentProject.id}/translate`, { method: 'POST' })
                .then(res => res.ok ? res.json() : Promise.reject(res))
                .then(renderProject)
                .catch(err => {
                    console.error(err);
                    alert('ë²ˆì—­ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                })
                .finally(() => {
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'ë²ˆì—­ ì‹¤í–‰';
                    }
                });
        }

        function runVoiceSynthesis() {
            const btn = document.getElementById('voice-btn');
            btn.disabled = true;
            btn.textContent = 'ìŒì„± ìƒì„± ì¤‘...';

            fetch(`/api/translator/projects/${currentProject.id}/voice`, { method: 'POST' })
                .then(res => res.ok ? res.json() : Promise.reject(res))
                .then(renderProject)
                .catch(err => {
                    console.error(err);
                    alert('ìŒì„± ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                })
                .finally(() => {
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'ìŒì„± ìƒì„±';
                    }
                });
        }

        function runRender() {
            const btn = document.getElementById('render-btn');
            btn.disabled = true;
            btn.textContent = 'ë Œë”ë§ ì¤‘...';

            fetch(`/api/translator/projects/${currentProject.id}/render`, { method: 'POST' })
                .then(res => res.ok ? res.json() : Promise.reject(res))
                .then(project => {
                    renderProject(project);
                    const videoPath = project.extra.rendered_video_path;
                    if (videoPath) {
                        const videoLink = document.createElement('a');
                        videoLink.href = videoPath.replace('/home/sk/ws/mcp-playwright', '');
                        videoLink.textContent = 'ë‹¤ìš´ë¡œë“œ';
                        videoLink.target = '_blank';
                        projectActions.appendChild(videoLink);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                })
                .finally(() => {
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'ë¹„ë””ì˜¤ ë Œë”ë§';
                    }
                });
        }

        async function saveSegmentText(segmentId, textType, textValue) {
            try {
                const response = await fetch(`/api/translator/projects/${currentProject.id}/segments`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        segment_id: segmentId,
                        text_type: textType,
                        text_value: textValue
                    })
                });

                if (response.ok) {
                    console.log(`Successfully saved ${textType} text for segment ${segmentId}`);
                    return true;
                } else {
                    console.error('Failed to save segment text:', response.status, response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('Error saving segment text:', error);
                return false;
            }
        }

        function loadProject(id) {
            fetch(`/api/translator/projects/${id}`)
                .then(res => res.ok ? res.json() : Promise.reject(res))
                .then(renderProject)
                .catch(err => {
                    console.error(err);
                    creationView.innerHTML = '<p class="empty-state error">í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                });
        }

        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');

        function loadInitialSettings() {
            const cacheBuster = Date.now();
            fetch(`/api/translator/settings?_cb=${cacheBuster}`)
                .then(res => {
                    if (res.ok) {
                        return res.json();
                    } else {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                })
                .then(settings => {
                    applySettings(settings);
                })
                .catch(err => {
                    console.error('Failed to load initial settings:', err);
                });
        }

        function attachSegmentEventListeners() {
            // Edit text buttons
            document.querySelectorAll('.btn-edit-text').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const segmentId = e.target.dataset.segmentId;
                    const textType = e.target.dataset.type;
                    const textContent = e.target.closest('.text-content');
                    const textDisplay = textContent.querySelector('.text-display');
                    const textEdit = textContent.querySelector('.text-edit');

                    if (e.target.textContent === 'ìˆ˜ì •') {
                        // Enter edit mode
                        textEdit.value = textDisplay.textContent;
                        textDisplay.style.display = 'none';
                        textEdit.style.display = '';
                        textEdit.focus();
                        e.target.textContent = 'ì €ì¥';
                    } else if (e.target.textContent === 'ì €ì¥') {
                        // Save changes
                        const newText = textEdit.value.trim();

                        // ì €ì¥ ì¤‘ í‘œì‹œ
                        const originalText = e.target.textContent;
                        e.target.textContent = 'ì €ì¥ ì¤‘...';
                        e.target.disabled = true;

                        // ì„œë²„ì— ì €ì¥
                        saveSegmentText(segmentId, textType, newText).then(success => {
                            if (success) {
                                textDisplay.textContent = newText;
                                textDisplay.style.display = '';
                                textEdit.style.display = 'none';
                                e.target.textContent = 'ìˆ˜ì •';

                                // ì €ì¥ ì‹œê°„ í‘œì‹œ
                                const now = new Date();
                                const timeString = now.toLocaleString('ko-KR', {
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit'
                                });
                                const lastModifiedDiv = textContent.querySelector('.last-modified');
                                lastModifiedDiv.textContent = `ë§ˆì§€ë§‰ ì €ì¥: ${timeString}`;
                                lastModifiedDiv.style.color = '#28a745';

                                // ì„±ê³µ í‘œì‹œ
                                const originalColor = e.target.style.backgroundColor;
                                e.target.textContent = 'âœ“ ì €ì¥ì™„ë£Œ';
                                e.target.style.backgroundColor = '#28a745';
                                e.target.style.color = 'white';
                                setTimeout(() => {
                                    e.target.textContent = 'ìˆ˜ì •';
                                    e.target.style.backgroundColor = originalColor;
                                    e.target.style.color = '';
                                    // ì €ì¥ ì‹œê°„ ìƒ‰ìƒì„ ì›ë˜ëŒ€ë¡œ
                                    lastModifiedDiv.style.color = '#888';
                                }, 3000);
                            } else {
                                alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                                e.target.textContent = 'ì €ì¥';
                            }
                            e.target.disabled = false;
                        });
                    }
                });
            });

            // Copy text buttons
            document.querySelectorAll('.btn-copy-text').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const segmentId = e.target.dataset.segmentId;
                    const textType = e.target.dataset.type;
                    const textDisplay = e.target.closest('.text-content').querySelector('.text-display');
                    const textToCopy = textDisplay.textContent.trim();

                    if (!textToCopy) {
                        alert('ë³µì‚¬í•  í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    try {
                        await navigator.clipboard.writeText(textToCopy);
                        e.target.textContent = 'ë³µì‚¬ë¨';
                        setTimeout(() => {
                            e.target.textContent = 'ë³µì‚¬';
                        }, 1000);
                    } catch (err) {
                        console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                        // Fallback for older browsers
                        const textarea = document.createElement('textarea');
                        textarea.value = textToCopy;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);

                        e.target.textContent = 'ë³µì‚¬ë¨';
                        setTimeout(() => {
                            e.target.textContent = 'ë³µì‚¬';
                        }, 1000);
                    }
                });
            });

            // Reverse translate buttons (Japanese to Korean)
            document.querySelectorAll('.btn-translate-reverse').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const segmentId = e.target.dataset.segmentId;
                    const japaneseText = e.target.closest('.text-content').querySelector('.text-display').textContent.trim();

                    if (!japaneseText) {
                        alert('ë²ˆì—­í•  ì¼ë³¸ì–´ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    e.target.disabled = true;
                    e.target.textContent = 'ë²ˆì—­ì¤‘...';

                    try {
                        const response = await fetch(`/api/translator/projects/${currentProject.id}/reverse-translate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                segment_id: segmentId,
                                japanese_text: japaneseText
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const result = await response.json();

                        // Update reverse translation Korean text display
                        const segmentItem = e.target.closest('.segment-item');
                        const reverseKoreanTextDisplay = segmentItem.querySelector('.text-row.korean.reverse .text-display');
                        if (reverseKoreanTextDisplay) {
                            reverseKoreanTextDisplay.textContent = result.korean_text;
                        } else {
                            console.error('Cannot find reverse translation text display element');
                        }

                        // Update the server with the new reverse translated text
                        updateSegmentText(segmentId, 'reverse_translated', result.korean_text);

                    } catch (err) {
                        console.error('ì—­ë²ˆì—­ ì‹¤íŒ¨:', err);
                        alert('ì—­ë²ˆì—­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
                    } finally {
                        e.target.disabled = false;
                        e.target.textContent = 'ì—­ë²ˆì—­';
                    }
                });
            });

            // Delete text buttons
            document.querySelectorAll('.btn-delete-text').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const segmentId = e.target.dataset.segmentId;
                    const textType = e.target.dataset.type;

                    if (confirm(`ì •ë§ë¡œ ${textType === 'source' ? 'í•œêµ­ì–´' : 'ì¼ë³¸ì–´'} í…ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        updateSegmentText(segmentId, textType, '');
                        const textDisplay = e.target.closest('.text-content').querySelector('.text-display');
                        textDisplay.textContent = '';
                    }
                });
            });

            // Move up buttons
            document.querySelectorAll('.btn-move-up').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const segmentId = e.target.dataset.segmentId;
                    moveSegment(segmentId, 'up');
                });
            });

            // Move down buttons
            document.querySelectorAll('.btn-move-down').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const segmentId = e.target.dataset.segmentId;
                    moveSegment(segmentId, 'down');
                });
            });
        }

        function updateSegmentText(segmentId, textType, newText) {
            const payload = {
                segment_id: segmentId,
                text_type: textType,
                text_value: newText
            };

            fetch(`/api/translator/projects/${currentProject.id}/segments`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                return res.json();
            })
            .then(() => {
                // Update successful
                console.log(`Updated ${textType} for segment ${segmentId}`);
            })
            .catch(err => {
                console.error('Failed to update segment text:', err);
                alert('í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function moveSegment(segmentId, direction) {
            const segments = currentProject.segments;
            const currentIndex = segments.findIndex(seg => seg.id === segmentId);

            if (currentIndex === -1) {
                console.error('Segment not found:', segmentId);
                return;
            }

            let newIndex;
            if (direction === 'up' && currentIndex > 0) {
                newIndex = currentIndex - 1;
            } else if (direction === 'down' && currentIndex < segments.length - 1) {
                newIndex = currentIndex + 1;
            } else {
                // Cannot move - already at boundary
                return;
            }

            // Swap segments in the array
            const segmentToMove = segments[currentIndex];
            const segmentAtTarget = segments[newIndex];

            segments[currentIndex] = segmentAtTarget;
            segments[newIndex] = segmentToMove;

            // Update clip_index values to maintain order
            segments.forEach((seg, index) => {
                seg.clip_index = index;
            });

            // Save the reordered segments to the server
            fetch(`/api/translator/projects/${currentProject.id}/reorder-segments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    segment_orders: segments.map((seg, index) => ({
                        segment_id: seg.id,
                        new_index: index
                    }))
                })
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                return res.json();
            })
            .then(() => {
                // Re-render the project to show the new order
                renderProject(currentProject);
            })
            .catch(err => {
                console.error('Failed to reorder segments:', err);
                alert('ì„¸ê·¸ë¨¼íŠ¸ ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                // Revert the local changes
                segments[newIndex] = segmentToMove;
                segments[currentIndex] = segmentAtTarget;
            });
        }

        function updateVoiceSynthesisMode() {
            const select = document.getElementById('voice-synthesis-mode');
            const mode = select.value;

            fetch(`/api/translator/projects/${currentProject.id}/voice-synthesis-mode`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ voice_synthesis_mode: mode })
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                return res.json();
            })
            .then(() => {
                console.log(`Voice synthesis mode updated to: ${mode}`);
                currentProject.voice_synthesis_mode = mode;
            })
            .catch(err => {
                console.error('Failed to update voice synthesis mode:', err);
                alert('ìŒì„± í•©ì„± ëª¨ë“œ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                // Revert select to previous value
                select.value = currentProject.voice_synthesis_mode;
            });
        }

        function runReverseTranslateAll() {
            const btn = document.getElementById('reverse-translate-all-btn');
            btn.disabled = true;
            btn.textContent = 'ì „ì²´ ì—­ë²ˆì—­ ì¤‘...';

            let completedCount = 0;
            const totalSegments = currentProject.segments.filter(seg => seg.translated_text).length;

            if (totalSegments === 0) {
                alert('ì—­ë²ˆì—­í•  ì¼ë³¸ì–´ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                btn.disabled = false;
                btn.textContent = 'ì „ì²´ ì—­ë²ˆì—­';
                return;
            }

            // Process each segment with Japanese text
            currentProject.segments.forEach(async (segment, index) => {
                if (!segment.translated_text) return;

                try {
                    const response = await fetch(`/api/translator/projects/${currentProject.id}/reverse-translate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            segment_id: segment.id,
                            japanese_text: segment.translated_text
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();

                        // Update UI
                        const segmentElement = document.querySelector(`[data-segment-id="${segment.id}"]`);
                        if (segmentElement) {
                            const reverseDisplay = segmentElement.querySelector('.text-row.korean.reverse .text-display');
                            if (reverseDisplay) {
                                reverseDisplay.textContent = result.korean_text;
                            }
                        }

                        // Update server
                        updateSegmentText(segment.id, 'reverse_translated', result.korean_text);
                    }
                } catch (err) {
                    console.error(`Failed to reverse translate segment ${segment.id}:`, err);
                }

                completedCount++;
                if (completedCount === totalSegments) {
                    btn.disabled = false;
                    btn.textContent = 'ì „ì²´ ì—­ë²ˆì—­';
                    alert(`ì „ì²´ ì—­ë²ˆì—­ ì™„ë£Œ! (${completedCount}ê°œ ì„¸ê·¸ë¨¼íŠ¸)`);
                }
            });
        }

        function attachTimeEditListeners() {
            // Time display click to edit
            document.querySelectorAll('.time-display').forEach(timeDisplay => {
                timeDisplay.addEventListener('click', (e) => {
                    const segmentId = e.currentTarget.dataset.segmentId;
                    const timeEdit = document.querySelector(`.time-edit[data-segment-id="${segmentId}"]`);

                    // Hide display, show edit
                    e.currentTarget.style.display = 'none';
                    timeEdit.style.display = 'block';

                    // Focus on start input
                    timeEdit.querySelector('.start-input').focus();
                });
            });

            // Save time changes
            document.querySelectorAll('.btn-save-time').forEach(saveBtn => {
                saveBtn.addEventListener('click', async (e) => {
                    const segmentId = e.target.dataset.segmentId;
                    const timeEdit = e.target.closest('.time-edit');
                    const startInput = timeEdit.querySelector('.start-input');
                    const endInput = timeEdit.querySelector('.end-input');

                    const newStart = parseFloat(startInput.value);
                    const newEnd = parseFloat(endInput.value);

                    // Validation
                    if (newStart >= newEnd) {
                        alert('ì‹œì‘ ì‹œê°„ì€ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤.');
                        return;
                    }

                    if (newStart < 0 || newEnd < 0) {
                        alert('ì‹œê°„ì€ 0ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.');
                        return;
                    }

                    // Save to server
                    try {
                        const response = await fetch(`/api/translator/projects/${currentProject.id}/segments/timing`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                segment_id: segmentId,
                                start_time: newStart,
                                end_time: newEnd
                            })
                        });

                        if (response.ok) {
                            // Update display
                            const timeDisplay = document.querySelector(`.time-display[data-segment-id="${segmentId}"]`);
                            const startTime = timeDisplay.querySelector('.start-time');
                            const endTime = timeDisplay.querySelector('.end-time');
                            const duration = timeDisplay.querySelector('.time-duration');

                            startTime.textContent = `${Math.floor(newStart / 60)}:${(newStart % 60).toFixed(2).padStart(5, '0')}`;
                            endTime.textContent = `${Math.floor(newEnd / 60)}:${(newEnd % 60).toFixed(2).padStart(5, '0')}`;
                            duration.textContent = ` (${(newEnd - newStart).toFixed(1)}ì´ˆ)`;

                            // Hide edit, show display
                            timeEdit.style.display = 'none';
                            timeDisplay.style.display = 'block';

                            // Success feedback
                            saveBtn.textContent = 'âœ“';
                            setTimeout(() => {
                                saveBtn.textContent = 'ì €ì¥';
                            }, 1000);
                        } else {
                            alert('ì‹œê°„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    } catch (error) {
                        console.error('Time save error:', error);
                        alert('ì‹œê°„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            });

            // Cancel time edit
            document.querySelectorAll('.btn-cancel-time').forEach(cancelBtn => {
                cancelBtn.addEventListener('click', (e) => {
                    const segmentId = e.target.dataset.segmentId;
                    const timeEdit = e.target.closest('.time-edit');
                    const timeDisplay = document.querySelector(`.time-display[data-segment-id="${segmentId}"]`);

                    // Reset inputs to original values
                    const segment = currentProject.segments.find(s => s.id === segmentId);
                    if (segment) {
                        timeEdit.querySelector('.start-input').value = segment.start.toFixed(1);
                        timeEdit.querySelector('.end-input').value = segment.end.toFixed(1);
                    }

                    // Hide edit, show display
                    timeEdit.style.display = 'none';
                    timeDisplay.style.display = 'block';
                });
            });
        }

        function showAICommentarySection() {
            const aiCommentarySection = document.getElementById('ai-commentary-section');
            const translationSettingsSection = document.getElementById('translation-settings-section');

            // Show AI commentary section
            aiCommentarySection.style.display = 'block';

            // Keep translation settings section visible
            translationSettingsSection.style.display = 'block';

            // Update selected source info if selectedSource is available
            const videoNameElem = document.getElementById('selected-video-name');
            const subtitleNameElem = document.getElementById('selected-subtitle-name');

            if (selectedSource) {
                videoNameElem.textContent = selectedSource.base_name || '';
                subtitleNameElem.textContent = selectedSource.subtitle_path ? selectedSource.subtitle_path.split('/').pop() : 'ìë§‰ ì—†ìŒ';
            } else {
                // If no selectedSource, show placeholder text
                videoNameElem.textContent = 'í”„ë¡œì íŠ¸ì—ì„œ ì†ŒìŠ¤ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
                subtitleNameElem.textContent = 'í”„ë¡œì íŠ¸ì—ì„œ ì†ŒìŠ¤ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
            }

            // Scroll to AI commentary section with a slight delay for better UX
            setTimeout(() => {
                aiCommentarySection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);
        }

        // Make function globally accessible for debugging
        window.showAICommentarySection = showAICommentarySection;

        function showTranslationSettings() {
            const translationSettingsSection = document.getElementById('translation-settings-section');
            translationSettingsSection.style.display = 'block';

            // Scroll to translation settings
            translationSettingsSection.scrollIntoView({ behavior: 'smooth' });
        }

        async function generateAICommentary() {
            if (!selectedSource) {
                alert('ì†ŒìŠ¤ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const generateBtn = document.getElementById('generate-commentary-btn');
            const skipBtn = document.getElementById('skip-commentary-btn');
            const statusDiv = document.getElementById('commentary-generation-status');

            // Disable buttons and show status
            generateBtn.disabled = true;
            skipBtn.disabled = true;
            generateBtn.textContent = 'AI í•´ì„¤ ìƒì„± ì¤‘...';
            statusDiv.style.display = 'block';

            try {
                // First create the project
                const projectData = {
                    source_video: selectedSource.video_path,
                    source_subtitle: selectedSource.subtitle_path || null,
                    target_lang: 'ja',
                    translation_mode: 'literal',
                    tone_hint: 'ê°„ê²°í•˜ê²Œ'
                };

                const createResponse = await fetch('/api/translator/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(projectData)
                });

                if (!createResponse.ok) {
                    throw new Error(`í”„ë¡œì íŠ¸ ìƒì„± ì‹¤íŒ¨: ${createResponse.status}`);
                }

                const project = await createResponse.json();

                // Then generate AI commentary
                const commentaryResponse = await fetch(`/api/translator/projects/${project.id}/generate-commentary`, {
                    method: 'POST'
                });

                if (!commentaryResponse.ok) {
                    throw new Error(`AI í•´ì„¤ ìƒì„± ì‹¤íŒ¨: ${commentaryResponse.status}`);
                }

                const updatedProject = await commentaryResponse.json();

                // Load the project in the UI
                renderProject(updatedProject);

            } catch (error) {
                console.error('AI í•´ì„¤ ìƒì„± ì˜¤ë¥˜:', error);
                alert(`AI í•´ì„¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);

                // Re-enable buttons
                generateBtn.disabled = false;
                skipBtn.disabled = false;
                generateBtn.textContent = 'AI í•´ì„¤ ìƒì„±í•˜ê¸°';
                statusDiv.style.display = 'none';
            }
        }

        function skipAICommentary() {
            showTranslationSettings();
        }

        async function generateKoreanCommentary() {
            if (!currentProject) {
                alert('í”„ë¡œì íŠ¸ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const btn = document.getElementById('korean-commentary-btn');
            btn.disabled = true;
            btn.textContent = 'í•œêµ­ì–´ AI í•´ì„¤ ìƒì„± ì¤‘...';

            try {
                const response = await fetch(`/api/translator/projects/${currentProject.id}/generate-korean-commentary`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response details:', {
                        status: response.status,
                        statusText: response.statusText,
                        url: response.url,
                        body: errorText
                    });
                    throw new Error(`í•œêµ­ì–´ AI í•´ì„¤ ìƒì„± ì‹¤íŒ¨: ${response.status} - ${response.statusText} - ${errorText}`);
                }

                const updatedProject = await response.json();

                // Update current project and re-render
                renderProject(updatedProject);

                alert('í•œêµ­ì–´ AI í•´ì„¤ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');

            } catch (error) {
                console.error('í•œêµ­ì–´ í•´ì„¤ ìƒì„± ì˜¤ë¥˜:', error);
                alert(`í•œêµ­ì–´ AI í•´ì„¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'í•œêµ­ì–´ AI í•´ì„¤ ë„£ê¸°';
                }
            }
        }

        function deleteProject() {
            if (!confirm('ì •ë§ë¡œ ì´ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            const deleteBtn = document.getElementById('delete-project-btn');
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'ì‚­ì œ ì¤‘...';

            fetch(`/api/translator/projects/${currentProject.id}`, {
                method: 'DELETE'
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                return res.json();
            })
            .then(() => {
                alert('í”„ë¡œì íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/translator';
            })
            .catch(err => {
                console.error('Failed to delete project:', err);
                alert('í”„ë¡œì íŠ¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            })
            .finally(() => {
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'í”„ë¡œì íŠ¸ ì‚­ì œ';
                }
            });
        }

        function attachTimeEditListeners() {
            // Time display click to edit
            document.querySelectorAll('.time-display').forEach(timeDisplay => {
                timeDisplay.addEventListener('click', (e) => {
                    const segmentTimeDiv = e.target.closest('.segment-time');
                    const timeEdit = segmentTimeDiv.querySelector('.time-edit');

                    // Hide display, show edit
                    e.target.style.display = 'none';
                    timeEdit.style.display = 'inline-block';

                    // Focus on first input
                    timeEdit.querySelector('.start-input').focus();
                    timeEdit.querySelector('.start-input').select();
                });
            });

            // Save time button
            document.querySelectorAll('.btn-save-time').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const segmentTimeDiv = e.target.closest('.segment-time');
                    const segmentId = segmentTimeDiv.dataset.segmentId;
                    const timeDisplay = segmentTimeDiv.querySelector('.time-display');
                    const timeEdit = segmentTimeDiv.querySelector('.time-edit');
                    const startInput = timeEdit.querySelector('.start-input');
                    const endInput = timeEdit.querySelector('.end-input');

                    const startTime = parseFloat(startInput.value);
                    const endTime = parseFloat(endInput.value);

                    // Validation
                    if (startTime >= endTime) {
                        alert('ì‹œì‘ ì‹œê°„ì€ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤.');
                        return;
                    }

                    if (startTime < 0 || endTime < 0) {
                        alert('ì‹œê°„ì€ 0ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.');
                        return;
                    }

                    // Save to server
                    e.target.disabled = true;
                    e.target.textContent = 'ì €ì¥ì¤‘...';

                    try {
                        const response = await fetch(`/api/translator/projects/${currentProject.id}/segments/time`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                segment_id: segmentId,
                                start_time: startTime,
                                end_time: endTime
                            })
                        });

                        if (response.ok) {
                            // Update display
                            timeDisplay.textContent = `${startTime.toFixed(2)} - ${endTime.toFixed(2)}`;
                            timeEdit.style.display = 'none';
                            timeDisplay.style.display = 'inline';

                            // Success feedback
                            e.target.textContent = 'âœ“';
                            e.target.style.background = '#28a745';
                            setTimeout(() => {
                                e.target.textContent = 'ì €ì¥';
                                e.target.style.background = '';
                            }, 1500);
                        } else {
                            throw new Error('ì„œë²„ ì €ì¥ ì‹¤íŒ¨');
                        }
                    } catch (error) {
                        console.error('Time save error:', error);
                        alert('ì‹œê°„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    } finally {
                        e.target.disabled = false;
                        e.target.textContent = 'ì €ì¥';
                    }
                });
            });

            // Cancel time edit button
            document.querySelectorAll('.btn-cancel-time').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const segmentTimeDiv = e.target.closest('.segment-time');
                    const timeDisplay = segmentTimeDiv.querySelector('.time-display');
                    const timeEdit = segmentTimeDiv.querySelector('.time-edit');

                    // Reset inputs to original values
                    const segmentId = segmentTimeDiv.dataset.segmentId;
                    const segment = currentProject.segments.find(s => s.id === segmentId);
                    if (segment) {
                        timeEdit.querySelector('.start-input').value = segment.start.toFixed(2);
                        timeEdit.querySelector('.end-input').value = segment.end.toFixed(2);
                    }

                    // Hide edit, show display
                    timeEdit.style.display = 'none';
                    timeDisplay.style.display = 'inline';
                });
            });
        }

        // Add event listeners for AI commentary buttons
        document.getElementById('generate-commentary-btn').addEventListener('click', generateAICommentary);
        document.getElementById('skip-commentary-btn').addEventListener('click', skipAICommentary);

        if (projectId) {
            loadProject(projectId);
        } else {
            creationView.classList.remove('hidden');
            projectView.classList.add('hidden');
            fetchDownloads();
            loadInitialSettings();

            // Show AI commentary section on initial load
            showAICommentarySection();
        }
    })();
    </script>

    <style>
        .text-row.commentary {
            background: #f8f9ff;
            border-left: 3px solid #6c5ce7;
            padding-left: 10px;
            margin: 8px 0;
        }

        .text-row.commentary label {
            color: #6c5ce7;
            font-weight: bold;
        }

        .text-row.commentary .text-edit {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }

        .text-row.commentary .text-display {
            font-style: italic;
            color: #555;
            min-height: 20px;
        }

        .text-row.commentary .text-display:empty::before {
            content: 'í•´ì„¤ì„ ì…ë ¥í•˜ì„¸ìš”...';
            color: #999;
            font-style: italic;
        }

        #voice-synthesis-mode {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: #333;
        }

        #ai-commentary-section {
            border: 2px solid #007bff;
            border-radius: 10px;
            background: #f8fbff;
            box-shadow: 0 2px 10px rgba(0, 123, 255, 0.1);
        }

        #ai-commentary-section .panel-header h2 {
            color: #007bff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #ai-commentary-section .panel-header h2::before {
            content: 'ğŸ¤–';
            font-size: 1.2em;
        }

        .source-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .source-details h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }

        .source-details p {
            margin: 5px 0;
            color: #6c757d;
        }

        .ai-commentary-controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }

        .ai-commentary-controls button {
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
        }

        .status-message {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            color: #1565c0;
            font-weight: bold;
        }

        .status-message p {
            margin: 0;
        }
    </style>
</body>
</html>