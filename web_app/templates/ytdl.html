<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>유튜브 다운로드 도구</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="container">
    <header class="header">
        <h1>유튜브 다운로드 도구</h1>
        <nav>
            <a href="/">AI 쇼츠 메이커로 돌아가기</a>
        </nav>
    </header>

    <section class="panel">
        <h2>다운로드 설정</h2>
        <form method="post" action="/ytdl" class="ytdl-form">
            <div class="field">
                <label for="urls">유튜브 URL (여러 줄 입력 가능)</label>
                <textarea id="urls" name="urls" rows="4">{{ form_values.urls }}</textarea>
            </div>
            <div class="field inline">
                <label for="output_dir">저장 폴더</label>
                <input type="text" id="output_dir" name="output_dir" placeholder="현재 디렉터리" value="{{ form_values.output_dir }}">
                <label for="sub_langs">자막 언어</label>
                <input type="text" id="sub_langs" name="sub_langs" value="{{ form_values.sub_langs }}" placeholder="예: ko,en">
                <label for="sub_format">자막 형식</label>
                <input type="text" id="sub_format" name="sub_format" value="{{ form_values.sub_format }}">
            </div>
            <div class="field inline">
                <label><input type="checkbox" name="download_subs" {% if form_values.download_subs %}checked{% endif %}> 자막 다운로드</label>
                <label><input type="checkbox" name="auto_subs" {% if form_values.auto_subs %}checked{% endif %}> 자동 생성 자막 포함</label>
                <label><input type="checkbox" name="dry_run" {% if form_values.dry_run %}checked{% endif %}> 드라이런(미리보기)</label>
                <label><input type="checkbox" name="save_settings"> 현재 상태를 기본값으로 저장</label>
            </div>
            <button type="submit">실행</button>
        </form>
    </section>

    {% if settings_saved %}
    <div class="alert success">
        현재 설정을 기본값으로 저장했습니다.
    </div>
    {% endif %}

    {% if error %}
    <div class="alert error">
        <strong>오류:</strong> {{ error }}
    </div>
    {% endif %}

    {% if result %}
    <section class="panel">
        <h2>결과</h2>
        <p>
            {% if result.dry_run %}
            다운로드 예정 파일 ({{ result.count }}개)
            {% else %}
            다운로드 완료 파일 ({{ result.count }}개)
            {% endif %}
        </p>
        <p>자막 언어: {{ result.langs | join(", ") }}</p>
        <ul class="file-list">
            {% for item in result.files %}
            <li><code>{{ item }}</code></li>
            {% endfor %}
        </ul>
    </section>
    {% endif %}

    <section class="panel">
        <h2>다운로드 기록</h2>
        <div id="download-history">
            <div class="loading">기록을 불러오는 중...</div>
        </div>
    </section>

    <section class="panel info">
        <h2>사용 팁</h2>
        <ul>
            <li>`자막 언어`에 `ko,en`처럼 콤마로 구분하면 여러 언어를 받을 수 있습니다.</li>
            <li>영상 없이 자막만 확인하려면 `드라이런`을 체크하세요.</li>
            <li>`자동 생성 자막 포함`을 해제하면 업로드된 자막만 내려받습니다.</li>
        </ul>
    </section>
</div>

<script>
// Load and display download history
async function loadDownloadHistory() {
    try {
        const response = await fetch('/api/ytdl/history');
        const history = await response.json();
        displayHistory(history);
    } catch (error) {
        document.getElementById('download-history').innerHTML =
            '<div class="alert error">기록을 불러올 수 없습니다: ' + error.message + '</div>';
    }
}

function displayHistory(history) {
    const container = document.getElementById('download-history');

    if (history.length === 0) {
        container.innerHTML = '<div class="info">아직 다운로드 기록이 없습니다.</div>';
        return;
    }

    let html = '';
    history.forEach((record, index) => {
        const date = new Date(record.timestamp).toLocaleString('ko-KR');
        const urls = record.urls.join('<br>');

        html += `
            <div class="history-item">
                <div class="history-header">
                    <span class="timestamp">${date}</span>
                    <button class="delete-btn" onclick="deleteFiles(${index}, ${JSON.stringify(record.files).replace(/"/g, '&quot;')})">
                        파일 삭제
                    </button>
                </div>
                <div class="history-urls">
                    <strong>URL:</strong><br>
                    <small>${urls}</small>
                </div>
                <div class="history-files">
                    <strong>파일 (${record.files.length}개):</strong>
                    <ul class="file-list small">
                        ${record.files.map(file => `<li><code>${file}</code></li>`).join('')}
                    </ul>
                </div>
                <div class="history-settings">
                    <small>설정: ${record.settings.sub_langs} | ${record.settings.download_subs ? '자막O' : '자막X'}</small>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

async function deleteFiles(recordIndex, filePaths) {
    if (!confirm('선택한 파일들을 삭제하시겠습니까?')) {
        return;
    }

    try {
        const response = await fetch('/api/ytdl/files', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filePaths)
        });

        const result = await response.json();

        if (result.errors && result.errors.length > 0) {
            alert('일부 파일 삭제 중 오류가 발생했습니다:\n' + result.errors.join('\n'));
        } else {
            alert(`${result.deleted.length}개 파일이 삭제되었습니다.`);
        }

        // Reload history to reflect changes
        loadDownloadHistory();
    } catch (error) {
        alert('파일 삭제 중 오류가 발생했습니다: ' + error.message);
    }
}

// Load history when page loads
document.addEventListener('DOMContentLoaded', loadDownloadHistory);
</script>

<style>
.history-item {
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 10px;
    padding: 15px;
    background: #f9f9f9;
}

.history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.timestamp {
    font-weight: bold;
    color: #666;
}

.delete-btn {
    background: #ff4444;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
}

.delete-btn:hover {
    background: #cc0000;
}

.history-urls, .history-files, .history-settings {
    margin-bottom: 8px;
}

.file-list.small {
    font-size: 11px;
    max-height: 100px;
    overflow-y: auto;
}

.loading {
    text-align: center;
    color: #666;
    font-style: italic;
}

.info {
    text-align: center;
    color: #888;
    font-style: italic;
    padding: 20px;
}
</style>

</body>
</html>
